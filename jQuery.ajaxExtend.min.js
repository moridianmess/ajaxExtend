var ajaxExtend={version:"0.6.6",author:"Marc Evans (moridiweb)",options:{hide:function(){if(ajaxExtend.options.theme=="materialize"){$("#"+ajaxExtend.options.templateConfig.dialogId).closeModal()}else{if(ajaxExtend.options.theme=="bootstrap"){$("#"+ajaxExtend.options.templateConfig.dialogId).modal("hide")}}},show:function(){if(ajaxExtend.options.theme=="materialize"){$("#"+ajaxExtend.options.templateConfig.dialogId).openModal()}else{if(ajaxExtend.options.theme=="bootstrap"){$("#"+ajaxExtend.options.templateConfig.dialogId).modal("show")}}},beforeSend:function(a){},complete:function(a){},success:function(a,c,b){},abortCallback:function(){},error:function(b,c,a){},uploadProgress:function(g,c,a,f,e){var d=$("#processing-progress_"+c+" .progress-bar");var b=e+"%";d.width(b)},url:"",type:"GET",cache:false,fileUpload:false,form:$(),formData:{},dataType:"json",contentType:"application/json; charset=utf-8",processData:true,processing:true,data:{},authorisation:false,authorisationHeader:"TRUEREST",abort:false,ajaxCalls:{},ajaxCallBacks:{},key:"",text:"",customCall:{},log:{},timeout:1,theme:"materialize",templateDir:"/templates/ajaxExtend/",progressTemplate:"",templateConfig:{dialogId:"ajaxExtendDialog",bodyId:"ajaxExtendBody",buttonId:"ajaxExtendButton"},offlineCache:false,offlineNo:0,processRunning:false},create:function(){var b=$.Deferred();var a=b.promise();a.progress(function(){if($("#"+ajaxExtend.options.templateConfig.dialogId).length==0){templateEngine.load(ajaxExtend.options.templateDir+ajaxExtend.options.theme+"/progress.html",{}).then(function(c){ajaxExtend.options.progressTemplate=c;templateEngine.load(ajaxExtend.options.templateDir+ajaxExtend.options.theme+"/modal.html",ajaxExtend.options.templateConfig,$("body")).then(function(){$("#"+ajaxExtend.options.templateConfig.buttonId).on("click",{},function(d){ajaxExtend.abortAll();ajaxExtend.hide()});ajaxExtend.hide();$(document).ajaxStop(function(){ajaxExtend.options.timeout=setTimeout(function(){ajaxExtend.hide()},500)});b.resolve();$(document).trigger("processingCreate")})})}else{b.resolve();$(document).trigger("processingCreate")}});b.notify();return a},hide:function(){if($("#"+ajaxExtend.options.templateConfig.dialogId).is(":visible")){ajaxExtend.options.hide()}ajaxExtend.options.processRunning=false;$(document).trigger("processingHide")},show:function(){if(!$("#"+ajaxExtend.options.templateConfig.dialogId).is(":visible")){ajaxExtend.options.show()}$(document).trigger("processingShow")},set:function(a){ajaxExtend.options.customCall=$.extend(true,{},ajaxExtend.options);ajaxExtend.options.customCall=$.extend(true,ajaxExtend.options.customCall,a);$(document).trigger("processingSet")},supportFormData:function(){return !!window.FormData},execute:function(){var a=ajaxExtend.options.customCall;return ajaxExtend.doExecute(a)},doExecute:function(a){var c=$.Deferred();var b=c.promise();b.progress(function(){var e=a.data;var f="Object";if(a.data!=null){if(a.data.__proto__["constructor"]["name"]!==undefined){f=a.data.__proto__["constructor"]["name"]}}if(f!="FormData"){a.data=JSON.stringify(a.data)}if(a.fileUpload==true){if(ajaxExtend.supportFormData()){var h="";if(a.form instanceof jQuery){h="?formName="+a.form.attr("id")}$.each(e,function(i,j){if(h==""){h+="?"}else{h+="&"}h+=i+"="+j});$.ajax({url:a.url+h,type:"POST",beforeSend:function(j){ajaxExtend.options.processRunning=true;var l=0;var k=a.key;while(ajaxExtend.options.ajaxCalls[k]!==undefined){k=a.key+l.toString();l++}a.key=k;j.id=a.key;if($.isFunction(a.beforeSend)){a.beforeSend(j)}if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]={};ajaxExtend.options.log[a.key]["requestType"]=a.type;ajaxExtend.options.log[a.key]["requestUrl"]=a.url+h;ajaxExtend.options.log[a.key]["requestData"]=g}ajaxExtend.options.ajaxCalls[a.key]=j;if(a.authorisation){j.setRequestHeader("Authorization",a.authorisationHeader)}var m=a.text;if(m==""){m=a.key}if(a.processing){ajaxExtend.start(m,a.key,a.abort)}k=null;m=null},xhr:function(){var i=new window.XMLHttpRequest();i.upload.addEventListener("progress",function(m){var l=0;var j=m.loaded||m.position;var k=m.total;if(m.lengthComputable){l=Math.ceil(j/k*100)}a.uploadProgress(m,a.key,j,k,l);l=null;k=null;j=null},false);return i},success:function(i,m,k){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseData"]=i;ajaxExtend.options.log[a.key]["responseStatus"]=k.status;ajaxExtend.options.log[a.key]["responseText"]=k.responseText}if(a.offlineCache==true){var j=ajaxExtend.getStorageByValueObject({url:a.url,params:a.formData});if(j!=false){localStorage.setItem(j,JSON.stringify({data:i,url:a.url,params:JSON.parse(a.formData)}))}else{var l="offlineStorage"+ajaxExtend.options.offlineNo;ajaxExtend.options.offlineNo++;localStorage.setItem(l,JSON.stringify({data:i,url:a.url,params:JSON.parse(a.formData)}))}}if($.isFunction(a.success)){a.success(i,m,k)}$(document).trigger("ajaxExecute")},complete:function(i){$.each(ajaxExtend.options.ajaxCalls,function(j,k){if(k.id!==undefined){if(k.id==i.id){ajaxExtend.end(j)}}});if($.isFunction(a.complete)){a.complete(i)}c.resolve()},error:function(l,n,j){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseStatus"]=l.status;ajaxExtend.options.log[a.key]["responseText"]=l.responseText}if(a.offlineCache==true){var k=ajaxExtend.getStorageByValueObject({url:a.url,params:a.formData});if(k!=false){var m=JSON.parse(localStorage.getItem(k));if($.isFunction(a.success)){var i={readyState:4,responseText:m.data,status:200,statusText:"OK"};a.success(m.data,"success",i)}}else{}}else{}if($.isFunction(a.error)){a.error(l,n,j)}},data:a.formData,cache:false,contentType:false,processData:false});h=null}else{var g=$(":text",$(a.prefix+"Form")).serializeArray();ajaxExtend.options.processRunning=true;if(!$.isEmptyObject(a.data)){$.each(a.data,function(i,j){if(typeof(j)=="string"){g.push({name:i,value:j})}else{g.push({name:i,value:j.val()})}})}var d=a.fileArray.serializeArray();if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]={};ajaxExtend.options.log[a.key]["requestType"]=a.type;ajaxExtend.options.log[a.key]["requestUrl"]=a.url;ajaxExtend.options.log[a.key]["requestData"]=g}$.ajax(a.url,{data:g,files:d,iframe:true,processData:false}).complete(function(i){ajaxExtend.close();c.resolve()}).success(function(i,k,j){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseData"]=i;ajaxExtend.options.log[a.key]["responseStatus"]=j.status;ajaxExtend.options.log[a.key]["responseText"]=j.responseText}if($.isFunction(a.success)){a.success(i,k,j)}}).error(function(j,k,i){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseStatus"]=j.status;ajaxExtend.options.log[a.key]["responseText"]=j.responseText}if($.isFunction(a.error)){a.error(j,k,i)}});g=null;d=null}}else{$.ajax({url:a.url,dataType:a.dataType,processData:a.processData,cache:a.cache,type:a.type,xhr:function(){var i=new window.XMLHttpRequest();i.upload.addEventListener("progress",function(m){var l=0;var j=m.loaded||m.position;var k=m.total;if(m.lengthComputable){l=Math.ceil(j/k*100)}a.uploadProgress(m,a.key,j,k,l);l=null;k=null;j=null},false);i.addEventListener("progress",function(m){var l=0;var j=m.loaded||m.position;var k=m.total;if(m.lengthComputable){l=Math.ceil(j/k*100)}a.uploadProgress(m,a.key,j,k,l);l=null;k=null;j=null},false);return i},beforeSend:function(j){ajaxExtend.options.processRunning=true;var l=0;var k=a.key;while(ajaxExtend.options.ajaxCalls[k]!==undefined){k=a.key+l.toString();l++}a.key=k;j.id=a.key;if($.isFunction(a.beforeSend)){a.beforeSend(j)}if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]={};ajaxExtend.options.log[a.key]["requestType"]=a.type;ajaxExtend.options.log[a.key]["requestUrl"]=a.url;ajaxExtend.options.log[a.key]["requestData"]=a.data}ajaxExtend.options.ajaxCalls[a.key]=j;ajaxExtend.options.ajaxCallBacks[a.key]=a.abortCallback;if(a.authorisation){j.setRequestHeader("Authorization",a.authorisationHeader)}var m=a.text;if(m==""){m=a.key}if(a.processing){ajaxExtend.start(m,a.key,a.abort)}m=null;k=null},contentType:a.contentType,data:a.data,success:function(i,m,k){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseData"]=i;ajaxExtend.options.log[a.key]["responseStatus"]=k.status;ajaxExtend.options.log[a.key]["responseText"]=k.responseText}if(a.offlineCache==true){var j=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(j!=false){localStorage.setItem(j,JSON.stringify({data:i,url:a.url,params:JSON.parse(a.data)}))}else{var l="offlineStorage"+ajaxExtend.options.offlineNo;ajaxExtend.options.offlineNo++;localStorage.setItem(l,JSON.stringify({data:i,url:a.url,params:JSON.parse(a.data)}))}}if($.isFunction(a.success)){a.success(i,m,k)}$(document).trigger("ajaxExecute")},complete:function(i){$.each(ajaxExtend.options.ajaxCalls,function(j,k){if(k.id!==undefined){if(k.id==i.id){ajaxExtend.end(j)}}});if($.isFunction(a.complete)){a.complete(i)}c.resolve()},error:function(l,n,j){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseStatus"]=l.status;ajaxExtend.options.log[a.key]["responseText"]=l.responseText}if(a.offlineCache==true){var k=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(k!=false){var m=JSON.parse(localStorage.getItem(k));if($.isFunction(a.success)){var i={readyState:4,responseText:m.data,status:200,statusText:"OK"};a.success(m.data,"success",i)}}else{}}else{}if($.isFunction(a.error)){a.error(l,n,j)}}})}f=null;e=null});c.notify();return b},setExecute:function(a){var c=$.Deferred();var b=c.promise();b.progress(function(){var d=ajaxExtend.options;var e=$.extend(true,{},d);e=$.extend(true,e,a);ajaxExtend.doExecute(e).then(function(){c.resolve()});e=null});c.notify();return b},buildOptions:function(j,c){var a=ajaxExtend.options.customCall;if($.isArray(j)){for(var b=0;b<j.length;b++){var f=j[b];var d="option";var h=0;if(f.type!==undefined){d=f.type}if(f.parent!==undefined){h=f.parent}var g=$(document.createElement(d));if(d=="option"){g.attr("value",f.value);g.html(f.name)}else{g.attr({"data-value":f.value,label:f.name})}if(d=="option"){if(h==0){c.append(g)}else{c.find("optgroup").each(function(){if($(this).attr("data-value")==h){$(this).append(g)}})}}else{c.append(g)}d=null;h=null;g=null}}},list:function(b){var a=ajaxExtend.options.customCall;$.ajax({url:a.url,dataType:a.dataType,processData:a.processData,cache:a.cache,type:a.type,xhr:function(){var c=new window.XMLHttpRequest();c.upload.addEventListener("progress",function(g){var f=0;var d=g.loaded||g.position;var e=g.total;if(g.lengthComputable){f=Math.ceil(d/e*100)}a.uploadProgress(g,a.key,d,e,f);f=null;e=null;d=null},false);c.addEventListener("progress",function(g){var f=0;var d=g.loaded||g.position;var e=g.total;if(g.lengthComputable){f=Math.ceil(d/e*100)}a.uploadProgress(g,a.key,d,e,f);f=null;e=null;d=null},false);return c},beforeSend:function(c){var e=0;var d=a.key;while(ajaxExtend.options.ajaxCalls[d]!==undefined){d=a.key+e.toString();e++}a.key=d;c.id=a.key;if($.isFunction(a.beforeSend)){a.beforeSend(c)}if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]={};ajaxExtend.options.log[a.key]["requestType"]=a.type;ajaxExtend.options.log[a.key]["requestUrl"]=a.url;ajaxExtend.options.log[a.key]["requestData"]=a.data}ajaxExtend.options.ajaxCalls[a.key]=c;ajaxExtend.options.ajaxCallBacks[a.key]=a.abortCallback;if(a.authorisation){c.setRequestHeader("Authorization",a.authorisationHeader)}var f=a.text;if(f==""){f=a.key}ajaxExtend.start(f,a.key,a.abort);d=null;f=null},uploadProgress:function(g,d,c,f,e){if($.isFunction(a.uploadProgress)){a.uploadProgress(g,d,c,f,e)}},contentType:a.contentType,data:a.data,success:function(c,g,e){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseData"]=c;ajaxExtend.options.log[a.key]["responseStatus"]=e.status;ajaxExtend.options.log[a.key]["responseText"]=e.responseText}if(a.offlineCache==true){var d=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(d!=false){localStorage.setItem(d,JSON.stringify({data:c,url:a.url,params:JSON.parse(a.data)}))}else{var f="offlineStorage"+ajaxExtend.options.offlineNo;ajaxExtend.options.offlineNo++;localStorage.setItem(f,JSON.stringify({data:c,url:a.url,params:JSON.parse(a.data)}))}}if(typeof b=="object"){b.find("option").remove();b.find("optgroup").remove();if(e.status==200){ajaxExtend.buildOptions(c.results,b)}else{if(e.status==204){ajaxExtend.buildOptions([{name:"No Results Found",value:""}],b)}}}if($.isFunction(a.success)){a.success(c,g,e)}$(document).trigger("ajaxListExecute")},complete:function(c){$.each(ajaxExtend.options.ajaxCalls,function(d,e){if(e.id!==undefined){if(e.id==c.id){ajaxExtend.end(d)}}});if($.isFunction(a.complete)){a.complete(c)}},error:function(f,h,d){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseStatus"]=f.status;ajaxExtend.options.log[a.key]["responseText"]=f.responseText}if(a.offlineCache==true){var e=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(e!=false){var g=JSON.parse(localStorage.getItem(e));if($.isFunction(a.success)){var c={readyState:4,responseText:g.data,status:200,statusText:"OK"};a.success(g.data,"success",c)}}else{}}else{}if($.isFunction(a.error)){a.error(f,h,d)}}})},listExecute:function(b,c){var a=ajaxExtend.options;var d=$.extend(true,{},a);d=$.extend(true,d,b);var a=d;d=null;$.ajax({url:a.url,dataType:a.dataType,processData:a.processData,cache:a.cache,type:a.type,xhr:function(){var e=new window.XMLHttpRequest();e.upload.addEventListener("progress",function(i){var h=0;var f=i.loaded||i.position;var g=i.total;if(i.lengthComputable){h=Math.ceil(f/g*100)}a.uploadProgress(i,a.key,f,g,h);h=null;g=null;f=null},false);e.addEventListener("progress",function(i){var h=0;var f=i.loaded||i.position;var g=i.total;if(i.lengthComputable){h=Math.ceil(f/g*100)}a.uploadProgress(i,a.key,f,g,h);h=null;g=null;f=null},false);return e},beforeSend:function(e){var g=0;var f=a.key;while(ajaxExtend.options.ajaxCalls[f]!==undefined){f=a.key+g.toString();g++}a.key=f;e.id=a.key;if($.isFunction(a.beforeSend)){a.beforeSend(e)}if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]={};ajaxExtend.options.log[a.key]["requestType"]=a.type;ajaxExtend.options.log[a.key]["requestUrl"]=a.url;ajaxExtend.options.log[a.key]["requestData"]=a.data}ajaxExtend.options.ajaxCalls[a.key]=e;ajaxExtend.options.ajaxCallBacks[a.key]=a.abortCallback;if(a.authorisation){e.setRequestHeader("Authorization",a.authorisationHeader)}var h=a.text;if(h==""){h=a.key}ajaxExtend.start(h,a.key,a.abort);h=null;f=null},uploadProgress:function(j,f,e,h,g){if($.isFunction(a.uploadProgress)){a.uploadProgress(j,f,e,h,g)}},contentType:a.contentType,data:a.data,success:function(e,i,g){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseData"]=e;ajaxExtend.options.log[a.key]["responseStatus"]=g.status;ajaxExtend.options.log[a.key]["responseText"]=g.responseText}if(a.offlineCache==true){var f=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(f!=false){localStorage.setItem(f,JSON.stringify({data:e,url:a.url,params:JSON.parse(a.data)}))}else{var h="offlineStorage"+ajaxExtend.options.offlineNo;ajaxExtend.options.offlineNo++;localStorage.setItem(h,JSON.stringify({data:e,url:a.url,params:JSON.parse(a.data)}))}}if(typeof c=="object"){c.find("option").remove();c.find("optgroup").remove();if(g.status==200){ajaxExtend.buildOptions(e.results,c)}else{if(g.status==204){ajaxExtend.buildOptions([{name:"No Results Found",value:""}],c)}}}if($.isFunction(a.success)){a.success(e,i,g)}$(document).trigger("ajaxListExecute")},complete:function(e){$.each(ajaxExtend.options.ajaxCalls,function(f,g){if(g.id!==undefined){if(g.id==e.id){ajaxExtend.end(f)}}});if($.isFunction(a.complete)){a.complete(e)}},error:function(h,j,f){if(a.key.indexOf("sendError")<0){ajaxExtend.options.log[a.key]["responseStatus"]=h.status;ajaxExtend.options.log[a.key]["responseText"]=h.responseText}if(a.offlineCache==true){var g=ajaxExtend.getStorageByValueObject({url:a.url,params:a.data});if(g!=false){var i=JSON.parse(localStorage.getItem(g));if($.isFunction(a.success)){var e={readyState:4,responseText:i.data,status:200,statusText:"OK"};a.success(i.data,"success",e)}}else{}}else{}if($.isFunction(a.error)){a.error(h,j,f)}}})},abort:function(b){var a=ajaxExtend.options;if(b in a.ajaxCalls){a.ajaxCalls[b].abort();var c=a.ajaxCallBacks[b];if($.isFunction(c)){c()}ajaxExtend.end(b)}$(document).trigger("ajaxAbort")},abortAll:function(){var a=ajaxExtend.options;$.each(a.ajaxCalls,function(b,c){ajaxExtend.abort(b)});$(document).trigger("ajaxAbortAll")},start:function(c,b,d){var a=ajaxExtend.options;clearTimeout(a.timeout);ajaxExtend.show();templateEngine.load(ajaxExtend.options.progressTemplate,{text:c,id:"processing-progress_"+b,buttonId:"processing-cancel-"+b},$("#"+ajaxExtend.options.templateConfig.bodyId)).then(function(){if(typeof c==="undefined"){c=""}$("#processing-progress_"+b+" div").css({width:"100%"});if(!d){$("#processing-cancel-"+b).hide()}$(document).trigger("ajaxStart")})},end:function(b){var a=ajaxExtend.options;delete a.ajaxCalls[b];ajaxExtend.complete(b);$(document).trigger("ajaxEnd")},complete:function(a){if($("#processing-progress_"+a).length>0){$("#processing-progress_"+a).remove()}$(document).trigger("ajaxComplete")},destroy:function(){$("#"+ajaxExtend.options.templateConfig.dialogId).remove()},serializeObject:function(d){var e={};var c=[];d.find(":disabled").each(function(){c.push($(this));$(this).removeAttr("disabled")});var b=d.serializeArray();$.each(b,function(){if(e[this.name]!==undefined){if(!e[this.name].push){e[this.name]=[e[this.name]]}e[this.name].push(this.value||"")}else{e[this.name]=this.value||""}});$.each(c,function(a,f){f.attr("disabled","disabled")});c=null;return e;e=null},getLog:function(){return ajaxExtend.options.log},getOpen:function(){var a=this;var b=this.options;return b.processRunning},getStorageByValueObject:function(f){var a=this;var b=this.options;var g=localStorage;for(var c=0;c<g.length;c++){var e=g.getItem(g.key(c));var d={};if(e.indexOf("{")>-1&&typeof(f)=="object"){e=JSON.parse(e);$.each(f,function(i,h){$.each(e,function(j,k){if(i==j){d[i]=k}})})}if(JSON.stringify(d)===JSON.stringify(f)){return g.key(c)}}return false}};